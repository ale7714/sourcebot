# Sourcebot
A news bot for your Wordpress website.

- [Config](#config)
- [Develop](#develop)
- [Test](#test)
- [Build](#build)
- [Deploy](#deploy)
- [Run](#run)
- [Contribute](#contribute)
- [Notes](#notes)

## <a name="config"></a> Config

Sourcebot uses Laravel which requires `APP_KEY` to get going. You can use `php artisan key:generate` or get one from [Browserling](https://www.browserling.com/tools/aes-encrypt). Be sure to prefix it with `base64:` e.g. `base64:K7Z/ibxUt1a6x8oPeT0d+arysQsx2MkStDaiGDlECJ8=`

For news data Sourcebot defaults to http://source.co.zw but you can change this to your own [Wordpress REST API](https://wordpress.org/plugins/rest-api/) by setting `WORDPRESS_API_HOST`. This should be the host where your Wordpress is installed. Don't include `/wp-json/wp/v2/`

## <a name="develop"></a> Develop
[![Code Climate](https://codeclimate.com/github/ejcnet/sourcebot/badges/gpa.svg)](https://codeclimate.com/github/ejcnet/sourcebot)

### Requirements
- A [Facebook Page](https://web.facebook.com/pages/create)
- A [Facebook App](https://developers.facebook.com/apps/) with the Facebook Messenger product
- [PHP 7.1+](http://php.net/downloads.php)
- [Xdebug](https://xdebug.org/download.php)
- [Composer](https://getcomposer.org/)
- A local web-server e.g. [Apache](https://www.apache.org/dyn/closer.cgi)
- A publicly accessible URL e.g. [ngrok](https://ngrok.com/)
- A Wordpress instance with the [Wordpress REST API](https://wordpress.org/plugins/rest-api/)

### First time

- Run `composer install`
- Visit localhost to confirm you see `index.php`
- Run `cp .env.example .env`
- Edit `.env`
- Run `phpunit`
- Run `ngrok http 80` to get the publicly accessible URL
- Go to your [Facebook App](https://developers.facebook.com/apps/)
- Click `Webhooks`
- Select `Page` from the drop-down
- Click `Subscribe to this topic`
- Enter the publicly accessible URL of your app and `/webhook.php`
- Enter the `FACEBOOK_VERIFY_TOKEN`
- Click `Verify and Save`
- Visit [Facebook Messenger](https://messenger.com)
- Search for your Facebook Page and send it a message

## <a name="test"></a> Test
[![Test Coverage](https://codeclimate.com/github/ejcnet/sourcebot/badges/coverage.svg)](https://codeclimate.com/github/ejcnet/sourcebot/coverage)

Tests are run with `phpunit`

## <a name="build"></a> Build
[![CircleCI](https://circleci.com/gh/ejcnet/sourcebot.svg?style=svg)](https://circleci.com/gh/Ejcnet/sourcebot)

Sourcebot is configured to build on [CircleCI](https://circleci.com/gh/Ejcnet/sourcebot).

You can run local CircleCI builds with `circleci build` using the [CircleCI CLI](https://circleci.com/docs/2.0/local-jobs/).

## <a name="deploy"></a> Deploy

You can deploy Sourcebot to your own web-server or quickly and for free to Heroku.

[![Deploy](https://www.herokucdn.com/deploy/button.svg)](https://heroku.com/deploy)

### Requirements

- A [Facebook Page](https://web.facebook.com/pages/create)
- A [Facebook App](https://developers.facebook.com/apps/) with the Facebook Messenger product
- [PHP 7.1+](http://php.net/downloads.php)
- [Composer](https://getcomposer.org/)
- A web-server e.g. [Apache](https://www.apache.org/dyn/closer.cgi)
  - SSL must be configured
- A Wordpress instance with the [Wordpress REST API](https://wordpress.org/plugins/rest-api/)

### Before Deploy

Before deploying you probably want to give your bot a nice home page as `web/index.php` currently displays this `README.md`.

### After Deploy

Once you have Sourcebot running on a publicly accessible URL you need to set and verify your Facebook App's Webhook.

- Go to your [Facebook App](https://developers.facebook.com/apps/)
- Click `Webhooks`
- Select `Page` from the drop-down
- Click `Subscribe to this topic`
- Enter the URL of your app and `/webhook.php`
- Enter the `FACEBOOK_VERIFY_TOKEN`
  - If you are using Heroku then it was autogenerated and you can get it from the `Reveal Config Vars` section of your Heroku app's `Settings`
- Click `Verify and Save`
- Visit [Facebook Messenger](https://messenger.com)
- Search for your Facebook Page and send it a message

## <a name="run"></a> Run

To check Sourcebot can connect to your Wordpress go to <code>/wordpress-api-status</code>

## <a name="contribute"></a> Contribute

Contributions are welcome and follows the straightforward Github pull request process:

- Fork
- Code
- Test
- Submit a pull request

## <a name="notes"></a> Notes

### Facebook Page and App

- Facebook Messenger requires SSL/HTTPS to communicate with Sourcebot.
- The [quickstart](https://developers.facebook.com/docs/messenger-platform/guides/quick-start) guide is useful for setting up your Facebook Page and Facebook App. You do not need to follow the Node.js instructions.
- Make sure you associate your Facebook App with your Facebook Page in `Settings -> Advanced -> App Page`.
- Your Facebook App has to be reviewed for the `pages_messaging` permission. Before it is approved only Administrators, Developers, and Testers on the Facebook App's Roles page can interact with the bot.
- You can only have one webhook endpoint setup per Facebook App so you probably want a `development` and a `production` Facebook App at least.
- You can only associate one Facebook App per Facebook Page so you probably want a `development` and a `production` Facebook Page at least.
